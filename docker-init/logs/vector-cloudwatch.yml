api:
  enabled: true
  address: 0.0.0.0:7135

sources:
  docker_host:
    type: docker_logs
    exclude_containers:
      - insforge-vector
    include_containers:
      - insforge
      - insforge-deno
      - insforge-postgrest
      - insforge-postgres

transforms:
  project_logs:
    type: remap
    inputs:
      - docker_host
    source: |-
      .project = "default"
      .event_message = del(.message)
      container = to_string!(del(.container_name))
      if starts_with(container, "/") {
          .appname = slice!(container, 1)
      } else {
          .appname = container
      }
      del(.container_created_at)
      del(.container_id)
      del(.source_type)
      del(.stream)
      del(.label)
      del(.image)
      del(.host)

  router:
    type: route
    inputs:
      - project_logs
    route:
      insforge: '.appname == "insforge"'
      deno: '.appname == "insforge-deno"'
      rest: '.appname == "insforge-postgrest"'
      db: '.appname == "insforge-postgres"'

  rest_logs:
    type: remap
    inputs:
      - router.rest
    source: |-
      parsed, err = parse_regex(.event_message, r'^(?P<time>\d{2}/\w{3}/\d{4}:\d{2}:\d{2}:\d{2} [+-]\d{4}): (?P<msg>.*)$')
      if err == null && parsed != null {
          .event_message = parsed.msg
          .metadata.level = "info"
      } else {
          .metadata.level = "info"
      }

  insforge_logs:
    type: remap
    inputs:
      - router.insforge
    source: |-
      .event_message = replace!(.event_message, r'^\[backend\] ', "")
      req, err = parse_json(.event_message)
      if err == null {
          if req.timestamp != null {
              .timestamp = to_timestamp!(req.timestamp)
          }
          .level = req.level
          if req.duration != null {
              .user_agent = req.userAgent
              .ip = req.ip
              .method = req.method
              .path = req.path
              .protocol = "HTTP/1.1"
              .status_code = req.status
              .size = req.size
              .duration = req.duration
              .event_message = join!([req.method, req.path, to_string!(req.status), to_string!(req.size), req.duration, "-", req.ip, "-", req.userAgent], " ")
              .log_type = "request"
          } else {
              .event_message = join!([req.level, req.message], " - ")
              .log_type = "application"
              if req.error != null {
                  .error = req.error
              }
              if req.stack != null {
                  .stack = req.stack
              }
          }
      }

  deno_logs:
    type: remap
    inputs:
      - router.deno
    source: |-
      parsed, err = parse_regex(.event_message, r'^(?P<time>.*): (?P<msg>.*)$')
      if err == null {
          .event_message = parsed.msg
          .timestamp = to_timestamp!(parsed.time)
      }

  db_logs:
    type: remap
    inputs:
      - router.db
    source: |-
      parsed, err = parse_regex(.event_message, r'^(?P<time>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}\.\d{3}) (?P<tz>\w+) \[(?P<pid>\d+)\] (?P<level>LOG|ERROR|WARNING|INFO|NOTICE|FATAL|PANIC|STATEMENT|DETAIL): (?P<msg>.*)$')
      if err == null && parsed != null {
          .metadata.parsed.pid = parsed.pid
          .metadata.parsed.error_severity = upcase!(parsed.level)
          .event_message = parsed.msg
          if .metadata.parsed.error_severity == "STATEMENT" {
              .metadata.parsed.error_severity = "INFO"
          }
          if .metadata.parsed.error_severity == "DETAIL" {
              .metadata.parsed.error_severity = "INFO"
          }
      } else {
          .metadata.parsed.error_severity = "LOG"
      }

sinks:
  # File sinks - always write to local files
  file_insforge:
    type: 'file'
    inputs:
      - insforge_logs
    path: '/insforge-logs/insforge.logs.jsonl'
    encoding:
      codec: 'json'
  file_deno:
    type: 'file'
    inputs:
      - deno_logs
    path: '/insforge-logs/function.logs.jsonl'
    encoding:
      codec: 'json'
  file_rest:
    type: 'file'
    inputs:
      - rest_logs
    path: '/insforge-logs/postgrest.logs.jsonl'
    encoding:
      codec: 'json'
  file_db:
    type: 'file'
    inputs:
      - db_logs
    path: '/insforge-logs/postgres.logs.jsonl'
    encoding:
      codec: 'json'

  # CloudWatch sinks
  cw_insforge:
    type: aws_cloudwatch_logs
    inputs:
      - insforge_logs
    region: ${AWS_REGION}
    group_name: /insforge/local
    stream_name: ${HOSTNAME_OVERRIDE}-insforge-vector
    encoding:
      codec: json
  cw_rest:
    type: aws_cloudwatch_logs
    inputs:
      - rest_logs
    region: ${AWS_REGION}
    group_name: /insforge/local
    stream_name: ${HOSTNAME_OVERRIDE}-postgrest-vector
    encoding:
      codec: json
  cw_deno:
    type: aws_cloudwatch_logs
    inputs:
      - deno_logs
    region: ${AWS_REGION}
    group_name: /insforge/local
    stream_name: ${HOSTNAME_OVERRIDE}-function-vector
    encoding:
      codec: json
  cw_db:
    type: aws_cloudwatch_logs
    inputs:
      - db_logs
    region: ${AWS_REGION}
    group_name: /insforge/local
    stream_name: ${HOSTNAME_OVERRIDE}-postgres-vector
    encoding:
      codec: json
